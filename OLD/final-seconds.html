<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Seconds - StoryPaths</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Fira Code', monospace;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.3px;
        }
        
        .story-container {
            width: 95%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px 10px 20px 0;
        }
        
        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.5s;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid transparent;
            position: relative;
        }
        
        .message p {
            margin: 0;
            line-height: 1.6;
        }
        
        .agent {
            background: rgba(74, 171, 247, 0.1);
            border-left-color: #4dabf7;
            color: #fff;
        }
        
        .suspect {
            background: rgba(255, 107, 107, 0.1);
            border-left-color: #ff6b6b;
            color: #ff6b6b;
        }
        
        .system {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: #666;
            color: #999;
            font-style: italic;
            font-size: 13px;
        }
        
        .user-choice {
            background: rgba(81, 207, 102, 0.1);
            border-left-color: #51cf66;
            color: #51cf66;
        }
        
        .narrator {
            background: rgba(255, 212, 59, 0.1);
            border-left-color: #ffd43b;
            color: #ffd43b;
            font-style: italic;
        }
        
        .waiting-message {
            background: rgba(255, 212, 59, 0.1);
            border-left-color: #ffd43b;
            color: #ffd43b;
            font-style: italic;
            text-align: center;
        }
        
        .waiting-dots {
            display: inline-block;
            animation: pulse 1.5s infinite;
        }
        
        .character-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 11px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .message.faded {
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .typing-cursor {
            display: inline-block;
            background-color: #fff;
            width: 2px;
            height: 1em;
            animation: blink 1s infinite;
            margin-left: 2px;
        }
        
        .choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .choice-button {
            background-color: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 16px;
            color: #fff;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Fira Code', monospace;
            letter-spacing: 0.5px;
            position: relative;
        }
        
        .choice-button:hover {
            background-color: rgba(255, 255, 255, 0.07);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        .choice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .history-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .history-toggle:hover {
            background: rgba(40, 40, 40, 0.9);
        }
        
        .admin-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            display: none;
        }
        
        .admin-toggle {
            margin-bottom: 10px;
        }
        
        .admin-toggle input {
            margin-right: 5px;
        }
        
        .paywall-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #000;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .paywall-container {
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 30px;
            background-color: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .paywall-title {
            font-size: 20px;
            font-weight: 500;
            margin: 0 0 20px 0;
            color: #ff3b3b;
            letter-spacing: 0.5px;
        }
        
        .paywall-text {
            font-size: 16px;
            opacity: 0.9;
            margin: 0 0 30px 0;
            line-height: 1.5;
        }
        
        .continue-button {
            background-color: rgba(255, 255, 255, 0.9);
            color: #000;
            border: none;
            border-radius: 4px;
            padding: 14px 0;
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            font-family: 'Fira Code', monospace;
            letter-spacing: 1px;
        }
        
        .continue-button:hover {
            background-color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 59, 59, 0.2);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .typing-indicator {
            color: #999;
            font-style: italic;
            opacity: 0.7;
            animation: pulse 1.5s infinite;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .story-container {
                width: 98%;
                height: 95vh;
            }
        }
    </style>
</head>
<body>
    <div class="admin-controls" id="adminControls">
        <div class="admin-toggle">
            <input type="checkbox" id="adminMode" onchange="toggleAdminMode()">
            <label for="adminMode">Admin Mode</label>
        </div>
        <div class="admin-toggle">
            <input type="checkbox" id="skipTimer" disabled>
            <label for="skipTimer">Skip Timers</label>
        </div>
        <button onclick="resetStory()" style="margin-top: 10px; padding: 5px 10px; font-size: 10px;">Reset Story</button>
    </div>

    <div class="story-container">
        <div class="message-area" id="messageArea">
            <div class="message system">
                <p>ðŸ”´ LIVE - Secure comm-link established with Agent Emma Carter</p>
            </div>
        </div>
        
        <div class="choices" id="choices">
            <button class="choice-button" onclick="startStory()">
                Begin Mission
            </button>
        </div>
    </div>

    <div class="history-toggle" id="historyToggle" onclick="toggleHistory()">
        Show History
    </div>
    
    <div class="paywall-overlay" id="paywall">
        <div class="paywall-container">
            <h1 class="paywall-title">Continue Emma's Story</h1>
            <p class="paywall-text">The situation is becoming more complex. Your bond with Emma deepens as you guide her through increasingly difficult choices.</p>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <span style="opacity: 0.7;">Full story access:</span>
                <span style="font-size: 18px; font-weight: 500;">$4.99</span>
            </div>
            
            <button class="continue-button" onclick="unlockStory()">CONTINUE FOR $4.99</button>
            
            <a href="index.html" style="display: block; text-align: center; color: rgba(255, 255, 255, 0.5); font-size: 14px; text-decoration: none;">Return to stories</a>
        </div>
    </div>
    
    <script>
        // Game state with comprehensive tracking
        let gameState = {
            currentScene: 'start',
            isUnlocked: false,
            decisions: [],
            waitingFor: null,
            waitingUntil: null,
            adminMode: false,
            skipTimers: false,
            showHistory: false
        };

        // Enhanced character development and story structure
        const storyDatabase = {
        start: {
            messages: [
                {
                    type: 'agent',
                    speaker: 'Emma Carter',
                    text: "Control, do you copy? Emma here. You'd think by now the nerves would settle. But no, three missions in and my hands still shake like it's my first day at Quantico.",
                    delay: 1000
                },
                {
                    type: 'agent',
                    speaker: 'Emma Carter',
                    text: "I appreciated your guidance last missionâ€”it kept things from going sideways. Here's hoping you can pull that off again today.",
                    delay: 2500
                },
                {
                    type: 'system',
                    text: "Emma takes a deep breath. Through the comm-link, you sense her tension slowly easing, replaced by growing confidence in your partnership.",
                    delay: 2000
                },
                {
                    type: 'agent',
                    speaker: 'Emma Carter',
                    text: "I'm outside First Unity Bank. Weâ€™ve got three armed suspects and at least five hostages visible through the glass. Hostages appear scared but unharmed. How should we proceed?",
                    delay: 3000
                }
            ],
            choices: [
                {
                    id: 'observe',
                    text: 'Take a moment to observe carefully first.',
                    userResponse: "Emma, letâ€™s slow down a bit and carefully observe the situation first. We need a clearer picture before taking action.",
                    nextScene: 'observation'
                },
                {
                    id: 'immediate_contact',
                    text: 'Establish immediate communication with the suspects.',
                    userResponse: "Emma, we need direct communication immediately. Reach out and see what we're dealing with.",
                    nextScene: 'firstContact'
                },
                {
                    id: 'reposition',
                    text: 'Move to a better tactical position before proceeding.',
                    userResponse: "Before anything else, Emma, reposition to ensure you're safe and have the best tactical advantage possible.",
                    nextScene: 'positioning'
                }
            ]
        },

        observation: {
            messages: [
                {
                    type: 'system',
                    text: "Emma silently moves closer, adjusting her viewpoint carefully. Her calm breathing contrasts the tense silence of the comm-link.",
                    delay: 1500
                },
                {
                    type: 'agent',
                    speaker: 'Emma Carter',
                    text: "Okay, clear visual now. The oldest suspectâ€”mid-30s, restless. Keeps glancing at his watch. Definitely under some sort of pressure or timeline.",
                    delay: 2000
                },
                {
                    type: 'agent',
                    speaker: 'Emma Carter',
                    text: "The younger two look uncertain, nervous. Could be brothers by the looks of their interactions. They defer heavily to the older guy.",
                    delay: 2500
                },
                {
                    type: 'agent',
                    speaker: 'Emma Carter',
                    text: "I can do a thorough intel sweep, but it'll take about fifteen minutes. Should we invest the time or act now?",
                    delay: 2000
                }
            ],
            choices: [
                {
                    id: 'full_intel',
                    text: 'Invest time in thorough intelligence gathering.',
                    userResponse: "Take your time, Emma. Fifteen minutes of intel gathering might make all the difference. Let's play this smart.",
                    waitTime: 15,
                    nextScene: 'completeIntel'
                },
                {
                    id: 'act_quickly',
                    text: 'We have enough info; proceed immediately.',
                    userResponse: "We have what we need, Emma. Time is criticalâ€”letâ€™s proceed immediately with what we know.",
                    nextScene: 'rapidResponse'
                }
            ]
        },

            completeIntel: {
                messages: [
                    {
                        type: 'narrator',
                        text: '[15 minutes later]'
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Alright, I've got a much clearer picture now. The leader - I'm calling him 'Alpha' - he's definitely the brains. But here's the thing... I don't think this was planned as a robbery.",
                        delay: 1000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Alpha keeps looking at one specific hostage - a woman in a blue dress. She's not just terrified, she's... angry? Like she knows him. This might be personal.",
                        delay: 3000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "The two younger guys - they're scared. Really scared. I think they're in over their heads. Alpha's the one we need to focus on, but those two might be our way in.",
                        delay: 5000
                    }
                ],
                choices: [
                    {
                        id: 'focusAlpha',
                        text: 'Target Alpha directly - address the real threat',
                        userResponse: "Alpha is clearly the key player here, Emma. We need to target him directly and address the real threat head-on.",
                        nextScene: 'alphaConfrontation'
                    },
                    {
                        id: 'approachBrothers',
                        text: 'Try to turn the younger suspects against Alpha',
                        userResponse: "Those younger guys are scared, Emma. I think we should try to approach them - maybe we can turn them against Alpha if they're really in over their heads.",
                        nextScene: 'brotherStrategy'
                    },
                    {
                        id: 'investigateWoman',
                        text: 'Focus on the woman in blue - that connection is key',
                        userResponse: "That personal connection with the woman in blue dress is crucial, Emma. Let's focus on understanding that relationship - it might be the key to resolving this.",
                        nextScene: 'personalConnection'
                    }
                ]
            },

            firstContact: {
                messages: [
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Okay, going direct. Here goes nothing... *picks up megaphone* This is Agent Emma Carter with the FBI. I'd like to talk to whoever's in charge in there.",
                        delay: 1500
                    },
                    {
                        type: 'suspect',
                        speaker: 'Alpha',
                        text: "FBI?! I didn't call for the FBI! Where are the local cops? This is supposed to be a simple negotiation!",
                        delay: 3000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "He sounds... confused? Almost like he wasn't expecting law enforcement at all. Something's not right here. Should I press him on that, or play it safe?",
                        delay: 5000
                    }
                ],
                choices: [
                    {
                        id: 'pressConfusion',
                        text: 'Press him on his confusion about law enforcement',
                        userResponse: "Press him on that confusion, Emma. Ask him what he means about not expecting the FBI. Something doesn't add up here.",
                        nextScene: 'suspectPressure'
                    },
                    {
                        id: 'playSafe',
                        text: 'Play it safe and establish basic communication',
                        userResponse: "Let's play this safe for now, Emma. Don't push too hard yet - just establish basic communication and see what he's willing to tell us.",
                        nextScene: 'basicNegotiation'
                    },
                    {
                        id: 'showEmpathy',
                        text: 'Show empathy and try to understand his situation',
                        userResponse: "Emma, I want you to approach this with empathy. Try to understand what's really going on with him. There's more to this story.",
                        nextScene: 'empathyApproach'
                    }
                ]
            },

            positioning: {
                messages: [
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Good thinking. I'm repositioning to get better sight lines and cover. The bank's layout gives me a few options here...",
                        delay: 2000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Okay, I'm set up with a clear view of the main floor and three possible entry points. I feel much more confident from this position. My heart rate's actually dropping.",
                        delay: 4000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "You know what? Thanks for that. My training officer always said 'Position first, action second.' I was getting a bit too eager there. What's our next move?",
                        delay: 6000
                    }
                ],
                choices: [
                    {
                        id: 'observeFromPosition',
                        text: 'Use your position advantage to observe and gather intel',
                        userResponse: "Perfect, Emma. Now use that position advantage to observe and gather intelligence. Let's see what we can learn from this better vantage point.",
                        nextScene: 'tacticalObservation'
                    },
                    {
                        id: 'establishComms',
                        text: 'Establish communication from your position of strength',
                        userResponse: "Now that you're in a position of strength, Emma, let's establish communication with the suspects. You'll be negotiating from a much better place.",
                        nextScene: 'confidentContact'
                    },
                    {
                        id: 'coordinateBackup',
                        text: 'Coordinate with backup units before proceeding',
                        userResponse: "Before we proceed, Emma, I want you to coordinate with backup units. Let's make sure everyone's on the same page and positioned properly.",
                        waitTime: 10,
                        nextScene: 'teamCoordination'
                    }
                ]
            },

            empathyApproach: {
                messages: [
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Sir, I can hear in your voice that this isn't what you expected. My name is Emma. What's your name?",
                        delay: 1500
                    },
                    {
                        type: 'suspect',
                        speaker: 'Alpha',
                        text: "Marcus. Look, Emma, this wasn't supposed to happen like this. Those people in here - they shouldn't have been here today.",
                        delay: 3000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "He's opening up already. Marcus sounds genuinely distressed about the hostages being here. I think your empathy approach is working. He's not your typical bank robber.",
                        delay: 5000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "Emma, I need to talk to Victoria Chen. She's supposed to be the bank manager here. This is about my daughter.",
                        delay: 7000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Now we're getting somewhere. This is about his daughter, and he specifically wants to talk to the bank manager. This isn't a robbery - it's personal. How should I handle this?",
                        delay: 9000
                    }
                ],
                choices: [
                    {
                        id: 'askAboutDaughter',
                        text: 'Ask Marcus about his daughter and what happened',
                        userResponse: "Marcus sounds like he's in real pain, Emma. Ask him about his daughter. Find out what happened that brought him here today.",
                        nextScene: 'daughterStory'
                    },
                    {
                        id: 'findManager',
                        text: 'Offer to locate the bank manager Victoria Chen',
                        userResponse: "Emma, let's help him get what he came for. Offer to locate Victoria Chen and facilitate that conversation he needs to have.",
                        waitTime: 20,
                        nextScene: 'managerSearch'
                    },
                    {
                        id: 'negotiateRelease',
                        text: 'Use this information to negotiate hostage releases',
                        userResponse: "Now that we understand his motivation, Emma, let's use this information to negotiate the release of some hostages. Show him we're willing to work with him.",
                        nextScene: 'prematureNegotiation'
                    }
                ]
            },

            daughterStory: {
                messages: [
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Marcus, tell me about your daughter. What happened that brought you here today?",
                        delay: 1500
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "Sarah. She's 16. Victoria Chen approved a loan for her college fund three years ago. Sarah worked two jobs to save for college. Two jobs, Emma! Do you know how hard that is for a teenager?",
                        delay: 3000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "I can hear the pride in his voice when he talks about Sarah. But also pain. Something went wrong with that loan. I'm getting a clearer picture now.",
                        delay: 5000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "They called yesterday. The bank 'made an error.' Her college fund - gone. Some kind of clerical mistake tied up all her money. She starts college in three weeks, Emma.",
                        delay: 7000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Oh... now I understand. His daughter's future is on the line. This isn't about money - it's about a father's desperation. Marcus isn't a criminal, he's a desperate dad. How should I handle this?",
                        delay: 9000
                    }
                ],
                choices: [
                    {
                        id: 'validateFeelings',
                        text: 'Validate Marcus\'s feelings as a father',
                        userResponse: "Emma, I want you to validate what Marcus is feeling as a father. Let him know that you understand his desperation and that any parent would feel the same way.",
                        nextScene: 'fatherBond'
                    },
                    {
                        id: 'offerHelp',
                        text: 'Offer to help resolve the bank issue legally',
                        userResponse: "This is a problem we can actually solve, Emma. Offer to help resolve the bank issue through legal channels. Let's see if we can fix this the right way.",
                        nextScene: 'legalResolution'
                    },
                    {
                        id: 'focusHostages',
                        text: 'Acknowledge his pain but focus on hostage safety',
                        userResponse: "Emma, acknowledge his pain - what happened to Sarah is terrible. But we need to keep the focus on getting these hostages to safety first.",
                        nextScene: 'prioritizeHostages'
                    }
                ]
            },

            fatherBond: {
                messages: [
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Marcus, I can't imagine how helpless you must feel. Watching your daughter work so hard, and then having it all disappear because of someone else's mistake. Any parent would be furious.",
                        delay: 2000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "*Long pause* You... you get it. Emma, I've been calling them for 18 hours straight. They keep transferring me, putting me on hold. Sarah cried herself to sleep last night.",
                        delay: 4000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "He's starting to trust me. I can hear it in his voice - the defensiveness is melting away. This is good progress, but we're not done yet.",
                        delay: 6000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "The woman in the blue dress - that's Victoria Chen. She's been hiding behind her desk this whole time. Won't even look at me. She knows what she did.",
                        delay: 8000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "I can see Victoria now. She looks terrified, but... there's something else. Guilt, maybe? Marcus might be right about her involvement. What's our next move?",
                        delay: 10000
                    }
                ],
                choices: [
                    {
                        id: 'confrontVictoria',
                        text: 'Ask Marcus to let you speak with Victoria Chen',
                        userResponse: "Marcus, I believe you about Victoria. Would you be willing to let me speak with her directly? Maybe we can get to the bottom of what really happened with Sarah's money.",
                        nextScene: 'victoriaConversation'
                    },
                    {
                        id: 'mediateConflict',
                        text: 'Offer to mediate between Marcus and Victoria',
                        userResponse: "Emma, I think you should offer to mediate between Marcus and Victoria. Help them have the conversation they should have had yesterday, but in a controlled way.",
                        nextScene: 'mediation'
                    },
                    {
                        id: 'separateIssues',
                        text: 'Try to separate the hostage situation from the bank issue',
                        userResponse: "Emma, we need to try to separate these two issues. The hostage situation and the bank problem are different - let's handle them separately.",
                        nextScene: 'separateProblems'
                    }
                ]
            },

            victoriaConversation: {
                messages: [
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Marcus, would you be willing to let me talk to Victoria? Maybe we can get to the bottom of what happened with Sarah's college fund.",
                        delay: 2000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "Fine. But she better tell the truth this time. Victoria! The FBI agent wants to talk to you.",
                        delay: 4000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Victoria looks terrified but she's moving toward the phone. I can see her hands shaking. Marcus is watching her every move but he's letting this happen. Good call.",
                        delay: 6000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Victoria Chen',
                        text: "This is Victoria Chen. Please, I have two children at home. I... I made a mistake with the Chen account. A terrible mistake.",
                        delay: 8000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "She's admitting to the mistake already. Marcus was right - she did something wrong. But she's also a mother herself. This is getting complicated.",
                        delay: 10000
                    }
                ],
                choices: [
                    {
                        id: 'getDetails',
                        text: 'Get Victoria to explain exactly what happened',
                        userResponse: "Victoria, I need you to tell me exactly what happened with Sarah's college fund. Marcus deserves to understand the full truth.",
                        nextScene: 'bankError'
                    },
                    {
                        id: 'findSolution',
                        text: 'Focus on finding a solution rather than blame',
                        userResponse: "Victoria, what's done is done. Right now I'm more interested in finding a solution than assigning blame. Can this be fixed?",
                        nextScene: 'solutionFocused'
                    },
                    {
                        id: 'reassureVictoria',
                        text: 'Reassure Victoria while gathering information',
                        userResponse: "Victoria, I can hear how upset you are about this. Take a deep breath and tell me what happened. We're going to work through this together.",
                        nextScene: 'reassurance'
                    }
                ]
            },

            bankError: {
                messages: [
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Victoria, I need you to tell me exactly what happened with Sarah's college fund. Marcus deserves to understand.",
                        delay: 2000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Victoria Chen',
                        text: "I... I accidentally transferred her funds to cover a deficit in another account. It was late, I was tired, and I mixed up the account numbers. It should never have happened.",
                        delay: 4000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "Accidentally?! My daughter's entire future, and you 'accidentally' stole it? Do you know how many hours she worked for that money?",
                        delay: 6000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Marcus is getting agitated again. His voice is rising and I can see him pacing. But Victoria looks genuinely remorseful. This was a mistake, not malice.",
                        delay: 8000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Victoria Chen',
                        text: "Marcus, please. I have the authority to fix this immediately. I can transfer the funds back right now, plus additional compensation for the stress this has caused.",
                        delay: 10000
                    }
                ],
                choices: [
                    {
                        id: 'acceptOffer',
                        text: 'Encourage Marcus to accept Victoria\'s immediate fix',
                        userResponse: "Marcus, this is what you came here for. Victoria is offering to fix this right now - Sarah's college fund can be restored today, with extra compensation.",
                        nextScene: 'quickResolution'
                    },
                    {
                        id: 'ensureAccountability',
                        text: 'Ensure proper accountability and documentation',
                        userResponse: "Victoria, that's a start, but we need proper accountability here. I want this documented officially so it can never happen again to another family.",
                        waitTime: 25,
                        nextScene: 'formalProcess'
                    },
                    {
                        id: 'addressEmotions',
                        text: 'Address the emotional impact on Marcus and Sarah',
                        userResponse: "Before we talk about money, we need to address the emotional impact here. Marcus, Sarah - they've been through hell because of this mistake.",
                        nextScene: 'emotionalHealing'
                    }
                ]
            },

            quickResolution: {
                messages: [
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Marcus, Victoria is offering to fix this right now. Sarah's college fund can be restored today, with extra compensation. This is what you came here for.",
                        delay: 2000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "*Long pause* You... you really can fix it? Right now? Sarah won't lose her college dreams?",
                        delay: 4000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Victoria Chen',
                        text: "I'm logging into the system now. Yes, I can restore everything plus add $5,000 in compensation. I'm so sorry this happened, Marcus.",
                        delay: 6000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "I can see Marcus starting to break down. Relief, exhaustion, maybe some regret about how this all played out. The other two suspects - the brothers - they look confused but relieved.",
                        delay: 8000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "Emma... I never wanted to hurt anyone. I just... I couldn't let my daughter's dreams die because of some computer error. What happens to me now?",
                        delay: 10000
                    }
                ],
                choices: [
                    {
                        id: 'compassionateArrest',
                        text: 'We\'ll arrange the most compassionate arrest possible',
                        userResponse: "Marcus, you're going to have to face consequences for what happened today, but I promise we'll arrange the most compassionate arrest possible. You're not a criminal - you're a father who made a desperate choice.",
                        nextScene: 'gentleEnding'
                    },
                    {
                        id: 'negotiateCharges',
                        text: 'I\'ll work with the DA to minimize charges given the circumstances',
                        userResponse: "Marcus, I'm going to work with the District Attorney to minimize the charges given these circumstances. What you did today was wrong, but I understand why you did it.",
                        waitTime: 30,
                        nextScene: 'legalNegotiation'
                    },
                    {
                        id: 'focusFamily',
                        text: 'Let\'s call Sarah first to share the good news',
                        userResponse: "Before anything else happens, Marcus, let's call Sarah. She's been worried sick, and she deserves to hear that her college dreams are safe.",
                        nextScene: 'familyCall'
                    }
                ]
            },

            familyCall: {
                messages: [
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Marcus, before anything else happens, let's call Sarah. She's been worried sick, and she deserves to hear that her college dreams are safe.",
                        delay: 2000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "You... you'd let me do that? Even after everything I've done today?",
                        delay: 4000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Marcus, you're a father who loves his daughter. That doesn't excuse today, but it explains it. Victoria, can you hand him the phone?",
                        delay: 6000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "Sarah? Baby, it's Dad. Listen to me - your college fund is safe. It's all there, everything you worked for. You're going to college, sweetheart.",
                        delay: 8000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "I can hear Sarah crying through the phone. Relief, joy, confusion. Marcus is crying too. Even some of the hostages are tearing up. Sometimes this job reminds you why we do it.",
                        delay: 10000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "Emma, I need to face the consequences of what I did today. But thank you... thank you for letting me give my daughter hope before I lose everything else.",
                        delay: 12000
                    }
                ],
                choices: [
                    {
                        id: 'promiseSupport',
                        text: 'I promise to advocate for you during legal proceedings',
                        userResponse: "Marcus, I give you my word - I'll testify about what really happened here today. You're not a criminal, you're a desperate father who made a terrible choice for the right reasons.",
                        nextScene: 'advocateEnding'
                    },
                    {
                        id: 'arrangeFamily',
                        text: 'Let me arrange for Sarah to visit you before processing',
                        userResponse: "Marcus, let me see if I can arrange for Sarah to visit you before we have to process this officially. You both deserve a proper conversation after everything that's happened.",
                        waitTime: 45,
                        nextScene: 'familyReunion'
                    },
                    {
                        id: 'gradualSurrender',
                        text: 'Let\'s work through a gradual, dignified surrender',
                        userResponse: "Marcus, let's work through this step by step. A gradual, dignified surrender that respects what you were trying to do for your daughter.",
                        nextScene: 'dignifiedSurrender'
                    }
                ]
            },

            advocateEnding: {
                messages: [
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Marcus, I give you my word - I'll testify about what really happened here today. You're not a criminal, you're a desperate father who made a terrible choice for the right reasons.",
                        delay: 2000
                    },
                    {
                        type: 'suspect',
                        speaker: 'Marcus',
                        text: "I don't deserve your kindness, Emma. But I'll never forget it. Boys, put your weapons down. It's over.",
                        delay: 4000
                    },
                    {
                        type: 'system',
                        text: 'âœ… All three suspects surrendering peacefully. Weapons secured. Hostages safe.',
                        delay: 6000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "You know what? Today reminded me why I became a negotiator. Not every situation needs to end with violence. Sometimes people just need to be heard, understood, and shown compassion.",
                        delay: 8000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Control, this is Carter. Situation resolved. All hostages safe. Suspects in custody. And... thank you. Your guidance today was exactly what I needed. I feel like I've grown as both an agent and a person.",
                        delay: 10000
                    }
                ],
                choices: [
                    {
                        id: 'nextMission',
                        text: 'I\'m ready for your next challenging case',
                        userResponse: "Emma, I'm proud of how you handled this situation. I'm ready to work with you on whatever challenging case comes next.",
                        nextScene: 'continuePartnership'
                    },
                    {
                        id: 'debrief',
                        text: 'Let\'s conduct a detailed debrief to learn from today',
                        userResponse: "Emma, let's sit down and conduct a detailed debrief of what happened today. I want us both to learn from this experience and grow from it.",
                        nextScene: 'learningSession'
                    },
                    {
                        id: 'followUp',
                        text: 'I want to follow up on Marcus and Sarah\'s story',
                        userResponse: "Emma, I'd like to follow up on Marcus and Sarah's story when this is all over. I want to know how they're doing after everything that's happened.",
                        nextScene: 'epilogue'
                    }
                ]
            },

            epilogue: {
                messages: [
                    {
                        type: 'narrator',
                        text: '[Three weeks later]'
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "I wanted to update you on Marcus and Sarah. Your advocacy worked - he got community service and probation instead of prison time. Sarah started college last week with her full scholarship intact.",
                        delay: 2000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "She sent me a photo from her dorm room. Big smile, holding up a criminal justice textbook. She wants to become a negotiator like us. Says she wants to help families like hers.",
                        delay: 4000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "Marcus is volunteering at a financial literacy center, helping other families avoid the mistakes he made. Victoria Chen personally funds a scholarship now for kids from working families.",
                        delay: 6000
                    },
                    {
                        type: 'agent',
                        speaker: 'Emma Carter',
                        text: "What we did that day... it changed everyone involved. Including me. I've never felt more confident in my abilities, and I trust your judgment completely now. Ready for whatever comes next?",
                        delay: 8000
                    }
                ],
                choices: [
                    {
                        id: 'newChapter',
                        text: 'Let\'s begin a new chapter in your career',
                        userResponse: "Emma, I think we're ready to begin a new chapter in your career. You've proven yourself today - let's see what other challenges we can tackle together.",
                        nextScene: 'nextEpisode'
                    },
                    {
                        id: 'restartStory',
                        text: 'I\'d like to experience this story again with different choices',
                        userResponse: "Emma, I'd like to go back and experience this situation again, maybe make some different choices. Sometimes it's worth exploring how things might have gone differently.",
                        nextScene: 'restart'
                    },
                    {
                        id: 'exploreCharacter',
                        text: 'Tell me more about your background and training',
                        userResponse: "Emma, I realize I don't know much about your background. Tell me more about your training and what led you to become a negotiator.",
                        nextScene: 'characterBackstory'
                    }
                ]
            }
        };

        // Typing effect system
        function typeMessage(element, text, speed = 30) {
            return new Promise(resolve => {
                element.innerHTML = '';
                const cursor = document.createElement('span');
                cursor.className = 'typing-cursor';
                element.appendChild(cursor);
                
                let i = 0;
                const typeChar = () => {
                    if (i < text.length) {
                        element.insertBefore(document.createTextNode(text[i]), cursor);
                        i++;
                        setTimeout(typeChar, speed + Math.random() * 20);
                    } else {
                        cursor.remove();
                        resolve();
                    }
                };
                typeChar();
            });
        }

        // Message history management
        function fadeOldMessages() {
            if (!gameState.showHistory) {
                const messages = document.querySelectorAll('.message:not(:last-child):not(:nth-last-child(2)):not(:nth-last-child(3))');
                messages.forEach(msg => msg.classList.add('faded'));
            }
        }

        function toggleHistory() {
            gameState.showHistory = !gameState.showHistory;
            const messages = document.querySelectorAll('.message');
            const toggle = document.getElementById('historyToggle');
            
            if (gameState.showHistory) {
                messages.forEach(msg => msg.classList.remove('faded'));
                toggle.textContent = 'Hide History';
            } else {
                fadeOldMessages();
                toggle.textContent = 'Show History';
            }
        }

        // Enhanced message system with proper sequencing
        let messageQueue = [];
        let isTyping = false;
        let choicesReady = false;

        function addMessage(type, text, speaker = null, delay = 0) {
            messageQueue.push({ type, text, speaker, delay });
            if (!isTyping) {
                processMessageQueue();
            }
        }

        async function processMessageQueue() {
            if (messageQueue.length === 0) {
                isTyping = false;
                if (choicesReady) {
                    showPendingChoices();
                }
                return;
            }

            isTyping = true;
            const { type, text, speaker, delay } = messageQueue.shift();

            // Wait for the delay before starting this message
            if (delay > 0) {
                await new Promise(resolve => setTimeout(resolve, delay));
            }

            const messageArea = document.getElementById('messageArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            let messageHTML = '';
            if (speaker) {
                messageHTML += `<div class="character-name">${speaker}</div>`;
            }
            messageHTML += `<p></p>`;
            
            messageDiv.innerHTML = messageHTML;
            messageArea.appendChild(messageDiv);
            
            const textElement = messageDiv.querySelector('p');
            
            // Type out the message and wait for it to complete
            await typeMessage(textElement, text);
            
            messageArea.scrollTop = messageArea.scrollHeight;
            fadeOldMessages();

            // Process the next message in the queue
            processMessageQueue();
        }

        // Waiting system for time-based actions
        function addWaitingMessage(description, estimatedTime) {
            const messageArea = document.getElementById('messageArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message waiting-message';
            messageDiv.id = 'waitingMessage';
            messageDiv.innerHTML = `<p>${description} <span class="waiting-dots">...</span> (estimated ${estimatedTime})</p>`;
            messageArea.appendChild(messageDiv);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        function removeWaitingMessage() {
            const waitingMsg = document.getElementById('waitingMessage');
            if (waitingMsg) {
                waitingMsg.remove();
            }
        }

        // Enhanced wait timer
        function startWaitTimer(minutes, acknowledgment, callback) {
            // Character acknowledges the action first
            addMessage('agent', acknowledgment, 'Emma Carter');
            
            setTimeout(() => {
                if (gameState.skipTimers && gameState.adminMode) {
                    callback();
                    return;
                }

                const timeText = minutes >= 60 ? `${Math.floor(minutes/60)}h ${minutes%60}m` : `${minutes}m`;
                addWaitingMessage('Waiting for response', timeText);
                
                gameState.waitingFor = callback;
                gameState.waitingUntil = Date.now() + (minutes * 60 * 1000);
                
                setTimeout(() => {
                    removeWaitingMessage();
                    callback();
                }, minutes * 60 * 1000);
            }, 2000);
        }

        // Admin controls
        function toggleAdminMode() {
            gameState.adminMode = document.getElementById('adminMode').checked;
            document.getElementById('skipTimer').disabled = !gameState.adminMode;
            if (gameState.adminMode) {
                document.getElementById('adminControls').style.display = 'block';
                gameState.skipTimers = document.getElementById('skipTimer').checked;
            } else {
                document.getElementById('adminControls').style.display = 'none';
                document.getElementById('skipTimer').checked = false;
                gameState.skipTimers = false;
            }
        }

        // Enhanced choice handling
        let pendingChoices = null;

        function showScene(sceneId) {
            const scene = storyDatabase[sceneId];
            if (!scene) return;

            gameState.currentScene = sceneId;
            document.getElementById('choices').style.display = 'none';
            choicesReady = false;
            pendingChoices = scene.choices;
            
            if (scene.messages) {
                // Clear message queue and add all messages
                messageQueue = [];
                scene.messages.forEach((message) => {
                    addMessage(message.type, message.text, message.speaker, message.delay || 0);
                });
                
                // Set flag that choices are ready to be shown
                choicesReady = true;
            } else {
                // Show choices immediately if no messages
                showChoices(scene.choices);
            }
        }

        function showPendingChoices() {
            if (pendingChoices) {
                showChoices(pendingChoices);
                pendingChoices = null;
                choicesReady = false;
            }
        }

        function showChoices(choices) {
            if (!choices) return;
            
            const choicesDiv = document.getElementById('choices');
            choicesDiv.innerHTML = '';
            
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.onclick = () => makeChoice(choice);
                button.textContent = choice.text;
                choicesDiv.appendChild(button);
            });
            
            choicesDiv.style.display = 'flex';
        }

        function makeChoice(choice) {
            if (!gameState.isUnlocked && gameState.decisions.length >= 3) {
                showPaywall();
                return;
            }
            
            gameState.decisions.push(choice);
            
            // Clear the message queue and add the user choice with natural dialogue
            messageQueue = [];
            addMessage('user-choice', choice.userResponse);
            document.getElementById('choices').style.display = 'none';
            choicesReady = false;
            
            if (choice.waitTime && choice.waitTime > 0) {
                const acknowledgments = [
                    "Understood. This will take some time, but I'll get it done right.",
                    "Copy that. Give me a few minutes to handle this properly.",
                    "Good call. I'll need some time for this, but it's worth doing right.",
                    "Roger. This is going to take a while, but I trust your judgment."
                ];
                const acknowledgment = acknowledgments[Math.floor(Math.random() * acknowledgments.length)];
                
                // Wait for user choice to finish typing, then start wait timer
                setTimeout(() => {
                    startWaitTimer(choice.waitTime, acknowledgment, () => showScene(choice.nextScene));
                }, choice.userResponse.length * 35 + 500);
            } else {
                // Wait for user choice to finish typing, then continue
                setTimeout(() => {
                    showScene(choice.nextScene);
                }, choice.userResponse.length * 35 + 500);
            }
        }

        function startStory() {
            showScene('start');
        }

        function showPaywall() {
            document.getElementById('paywall').style.display = 'flex';
        }

        function unlockStory() {
            gameState.isUnlocked = true;
            document.getElementById('paywall').style.display = 'none';
            addMessage('system', 'ðŸ”“ Story unlocked! Continue guiding Emma through complex decisions with lasting consequences.');
        }

        function resetStory() {
            if (confirm('Reset the entire story? This will lose all progress.')) {
                location.reload();
            }
        }

        // Initialize game
        if (window.location.hash.includes('admin') || window.location.search.includes('admin')) {
            document.getElementById('adminMode').checked = true;
            toggleAdminMode();
        }
    </script>
</body>
</html>